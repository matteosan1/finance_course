\chapter{Credit Default Swaps}
\label{ex-cds}

\begin{question}
Applying the bootstrapping technique, outlined in Chapter 10, derive the a credit curve from the following CDS market quotes and using \href{https://drive.google.com/file/d/1mugHyet3H9tcSAvYvt8G4_kpfaEbVY7b/view?usp=sharing}{discount\_curve\_ch10.xlsx}:
\end{question}

\begin{ipython}
observation_date = date(2020, 11, 1)
cds_quotes = [{'maturity': 12, 'spread':0.0149},
              {'maturity': 24, 'spread':0.0165},
              {'maturity': 36, 'spread':0.0173},
              {'maturity': 69, 'spread':0.0182},
              {'maturity': 120, 'spread':0.0183},
              {'maturity': 240, 'spread':0.0184}]
\end{ipython}

\begin{solution}
\end{solution}

\begin{ipython}
from finmarkets import generate_swap_dates, CreditDefaultSwap
from finmarkets import CreditCurve, DiscountCurve
from datetime import date
from scipy.optimize import minimize

observation_date = date(2020, 11, 1)
cds_quotes = [{'maturity': 12, 'spread':0.0149},
              {'maturity': 24, 'spread':0.0165},
              {'maturity': 36, 'spread':0.0173},
              {'maturity': 69, 'spread':0.0182},
              {'maturity': 120, 'spread':0.0183},
              {'maturity': 240, 'spread':0.0184}]

creditdefaultswaps = []
for quote in cds_quotes:
    creditdefswap = CreditDefaultSwap(1,
        observation_date, quote['maturity']//12,
        quote['spread'])
        
creditdefaultswaps.append(creditdefswap)
cds_pillar_dates.append(creditdefswap.payment_dates[-1])
cds_pillar_dates = sorted(cds_pillar_dates)
n_cds_vector = len(cds_pillar_dates)

def obj_function(unknown_ndps):
    curve_c = CreditCurve(
        cds_pillar_dates, unknown_ndps)

    sum_sq = 0.0
    for creditdefswap in creditdefaultswaps:
        sum_sq += creditdefswap.npv(discount_curve, curve_c) ** 2
    return sum_sq

x0_guess = [0.001 for i in range(n_cds_vector)]
bounds_credit_curve = [(0.01, 1) for i in range(n_cds_vector)]
bounds_credit_curve[0]=(1,1)

results = minimize(obj_function, x0_guess, bounds=bounds_credit_curve)
print (results.x)

[1. 0.90681257 0.80416782 0.70889095 0.54479309 0.29706549
0.08665777]
\end{ipython}

\begin{question}
Using the \texttt{Credit\ Curve} and \texttt{DiscountCurve} found in the previous question price the following CDS:
\end{question}

\begin{ipython}
cds_to_price = [{'nominal': 5000000, 'maturity': 18, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 30, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 42, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 72, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 108, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 132, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 160, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 184, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 210, 'spread': 0.02}]
\end{ipython}

\begin{solution}
\end{solution}

\begin{ipython}
from curve_data import discount_curve
from finmarkets import CreditDefaultSwap, CreditCurve
import datetime

observation_date = datetime.date(2020, 11, 1)
curve_pillar_dates = cd_pillar_dates
surv_prob = results.x
credit_curve = CreditCurve(curve_pillar_dates, surv_prob)
cds_to_price = [{'nominal': 5000000, 'maturity': 18, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 30, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 42, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 72, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 108, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 132, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 160, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 184, 'spread': 0.02},
                {'nominal': 5000000, 'maturity': 210, 'spread': 0.02}]

npv_cds_to_price = []
for quote in cds_to_price:
    creditdefswapprice = CreditDefaultSwap(
        quote['nominal'], pricing_date,
        quote['maturity']//12, quote['spread'])

npvcdstoprice = creditdefswapprice.npv(discount_curve, credit_curve)
npv_cds_to_price.append(npvcdstoprice)
print (npv_cds_to_price)

[-96879.21494231955, -125875.49083899031, -137489.2485942383,
 -150388.56810656283, -184387.14756564656, -199054.44398897374,
 -208689.7770410725, -216150.51575594302, -221690.38180709025]
\end{ipython}
