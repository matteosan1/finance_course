<<<<<<< HEAD
\chapter{Modelling Correlation Between Risks}

COPULÆ are an interesting mathematical tool to represent correlations between probability distributions. They can be used to represent complex dependencies in multivariate risk models, when more basic tools such as multivariate gaussian distributions are inappropriate. One commonly used application is sampling from correlated random variables.

    The definition of a \emph{copula} is: a multivariate distribution
=======
\chapter{Managing Correlations between Risks}

\section{Copulae}

The definition of a \emph{copula} is: a multivariate distribution
>>>>>>> 575d53dd9d3de451a336615921260b12794935f1
\(C(U_1, U_2, \ldots, U_n)\) such that marginalizing gives
\(U_i \approx\)\textasciitilde{}Uniform(0,1). Despite this obscure and
daunting sentence the concept is quite simple so let's try to clarify it
a bit and at the end we will see what role copulas played in the 2008
financial crisis.

\subsection{Example Problem Case}\label{example-problem-case}

Imagine we measure two variables that are non-normally distributed and
correlated. For example, we look at various rivers and for every river
we look at the maximum level of that river over a certain time-period.
In addition, we also count how many months each river caused flooding.
For the probability distribution of the maximum level of the river we
know that maximums are \href{}{\emph{Grumbel}} distributed, while the
number of flooding can be modelled according to a \href{}{\emph{Beta}}
distribution.

Clearly it is pretty reasonable to assume that the maximum level and the
number of floodings is going to be correlated, however we don't know how
we could model that correlated probability distribution. Above we only
specified the distributions for individual variables, irrespective of
the other one (i.e.~the marginals), in reality we are dealing with a
joint distribution of both of these together.

And here is where copulas come to our rescue.

Copulas essentially allow to decompose a joint probability distribution
into their marginals (which by definition have no correlation) and a
function which couples (hence the name) them together and thus allows us
to specify the correlation separately. The copula is that coupling
function.

Before going into them, we must first learn how we can transform
arbitrary random variables to uniform and back.

\subsection{Distribution
Transformation}\label{distribution-transformation}

The technique we are going to use to transform every random variables to
uniform and viceversa is called \emph{probability integral transform}.
We won't go into the details but we will just show few examples of how
this can be done in \texttt{python} and we will use the
\texttt{scipy.stats} module to do the job.

So first, we sample uniformly distributed values between 0 and 1:

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k+kn}{from} \PY{n+nn}{scipy} \PY{k}{import} \PY{n}{stats}
\PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{pyplot} \PY{k}{as} \PY{n}{plt}

\PY{n}{x} \PY{o}{=} \PY{n}{stats}\PY{o}{.}\PY{n}{uniform}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{l+m+mi}{10000}\PY{p}{)}

\PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    
Next we want to transform these samples so that instead of uniform they
are normally distributed. The transform that does this is the inverse of
the cumulative density function (CDF) of the normal distribution which
we can get in \texttt{scipy.stats} with \texttt{ppf}.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{norm} \PY{o}{=} \PY{n}{stats}\PY{o}{.}\PY{n}{distributions}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{p}{)} \PY{c+c1}{\PYZsh{} get the normal distribution definition}
\PY{n}{x\PYZus{}trans} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{ppf}\PY{p}{(}\PY{n}{x}\PY{p}{)}

\PY{n}{plt}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x\PYZus{}trans}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{)}
\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{copula_files/copula_3_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    If we plot them togheter in a 2D plot we can get a sense of what is
going on using the inverse CDF transformation:

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}

\PY{c+c1}{\PYZsh{} definitions for the axes}
\PY{n}{left}\PY{p}{,} \PY{n}{width} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.65}
\PY{n}{bottom}\PY{p}{,} \PY{n}{height} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.65}
\PY{n}{spacing} \PY{o}{=} \PY{l+m+mf}{0.005}

\PY{n}{rect\PYZus{}scatter} \PY{o}{=} \PY{p}{[}\PY{n}{left}\PY{p}{,} \PY{n}{bottom}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{n}{height}\PY{p}{]}
\PY{n}{rect\PYZus{}histx} \PY{o}{=} \PY{p}{[}\PY{n}{left}\PY{p}{,} \PY{n}{bottom} \PY{o}{+} \PY{n}{height} \PY{o}{+} \PY{n}{spacing}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{]}
\PY{n}{rect\PYZus{}histy} \PY{o}{=} \PY{p}{[}\PY{n}{left} \PY{o}{+} \PY{n}{width} \PY{o}{+} \PY{n}{spacing}\PY{p}{,} \PY{n}{bottom}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{height}\PY{p}{]}

\PY{c+c1}{\PYZsh{} start with a rectangular Figure}
\PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,} \PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}

\PY{n}{ax\PYZus{}scatter} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}scatter}\PY{p}{)}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{top}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{right}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\PY{n}{ax\PYZus{}histx} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}histx}\PY{p}{)}
\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{labelbottom}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\PY{n}{ax\PYZus{}histy} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}histy}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{labelleft}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}

\PY{c+c1}{\PYZsh{} the scatter plot:}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{scatter}\PY{p}{(}\PY{n}{x}\PY{p}{,} \PY{n}{x\PYZus{}trans}\PY{p}{)}

\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{set\PYZus{}xlim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{1.1}\PY{p}{)}\PY{p}{)}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{set\PYZus{}ylim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{4}\PY{p}{,} \PY{l+m+mi}{4}\PY{p}{)}\PY{p}{)}

\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x\PYZus{}trans}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{,} \PY{n}{orientation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{horizontal}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{set\PYZus{}xlim}\PY{p}{(}\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{get\PYZus{}xlim}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{set\PYZus{}ylim}\PY{p}{(}\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{get\PYZus{}ylim}\PY{p}{(}\PY{p}{)}\PY{p}{)}

\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{copula_files/copula_5_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    The inverse CDF stretches the outer regions of the uniform to yield a
normal distribution. The nice thing of the technique is that it can be
done for any arbitrary (univariate) probability distributions, like Beta
or Gumbel:

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{gumbel} \PY{o}{=} \PY{n}{stats}\PY{o}{.}\PY{n}{distributions}\PY{o}{.}\PY{n}{gumbel\PYZus{}l}\PY{p}{(}\PY{p}{)}
\PY{n}{x\PYZus{}trans} \PY{o}{=} \PY{n}{gumbel}\PY{o}{.}\PY{n}{ppf}\PY{p}{(}\PY{n}{x}\PY{p}{)}

\PY{c+c1}{\PYZsh{} definitions for the axes}
\PY{n}{left}\PY{p}{,} \PY{n}{width} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.65}
\PY{n}{bottom}\PY{p}{,} \PY{n}{height} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.65}
\PY{n}{spacing} \PY{o}{=} \PY{l+m+mf}{0.005}

\PY{n}{rect\PYZus{}scatter} \PY{o}{=} \PY{p}{[}\PY{n}{left}\PY{p}{,} \PY{n}{bottom}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{n}{height}\PY{p}{]}
\PY{n}{rect\PYZus{}histx} \PY{o}{=} \PY{p}{[}\PY{n}{left}\PY{p}{,} \PY{n}{bottom} \PY{o}{+} \PY{n}{height} \PY{o}{+} \PY{n}{spacing}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{]}
\PY{n}{rect\PYZus{}histy} \PY{o}{=} \PY{p}{[}\PY{n}{left} \PY{o}{+} \PY{n}{width} \PY{o}{+} \PY{n}{spacing}\PY{p}{,} \PY{n}{bottom}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{height}\PY{p}{]}

\PY{c+c1}{\PYZsh{} start with a rectangular Figure}
\PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,} \PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}

\PY{n}{ax\PYZus{}scatter} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}scatter}\PY{p}{)}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{top}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{right}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\PY{n}{ax\PYZus{}histx} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}histx}\PY{p}{)}
\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{labelbottom}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\PY{n}{ax\PYZus{}histy} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}histy}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{labelleft}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}

\PY{c+c1}{\PYZsh{} the scatter plot:}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{scatter}\PY{p}{(}\PY{n}{x}\PY{p}{,} \PY{n}{x\PYZus{}trans}\PY{p}{)}

\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{set\PYZus{}xlim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{1.1}\PY{p}{)}\PY{p}{)}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{set\PYZus{}ylim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{8}\PY{p}{,} \PY{l+m+mf}{2.5}\PY{p}{)}\PY{p}{)}

\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x\PYZus{}trans}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{,} \PY{n}{orientation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{horizontal}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{set\PYZus{}xlim}\PY{p}{(}\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{get\PYZus{}xlim}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{set\PYZus{}ylim}\PY{p}{(}\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{get\PYZus{}ylim}\PY{p}{(}\PY{p}{)}\PY{p}{)}

\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{copula_files/copula_7_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Clearly to do the opposite transformation from an arbitray distribution
to the uniform(0, 1) we can just apply the inverse of the inverse CDF,
the CDF itself\ldots{}

\subsection{Adding Correlation with Gaussian
Copulas}\label{adding-correlation-with-gaussian-copulas}

How does this help us with our problem of creating a custom joint
probability distriution ? We are actually almost done already, we know
how to convert anything uniformly distributed to an arbitrary
probability distribution. So that means we need to generate uniformly
distributed data with the correlation we want and then transform the
marginals into the desired distributions. How do we do that ? We
simulate from a multivariarte Gaussian with the specific corrrelation
structure, transform so that the marginals are uniform, and then
transform the uniform marginals to whatever we like.

Generate random samples from multivariate normal with correlation .5:

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} this import is for plotting}
\PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{colors}

\PY{n}{mvnorm} \PY{o}{=} \PY{n}{stats}\PY{o}{.}\PY{n}{multivariate\PYZus{}normal}\PY{p}{(}\PY{n}{mean}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{p}{,} \PY{n}{cov}\PY{o}{=}\PY{p}{[}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mf}{0.5}\PY{p}{]}\PY{p}{,}
                                                      \PY{p}{[}\PY{l+m+mf}{0.5}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{)}
\PY{n}{x} \PY{o}{=} \PY{n}{mvnorm}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{l+m+mi}{100000}\PY{p}{)}

\PY{c+c1}{\PYZsh{} definitions for the axes}
\PY{n}{left}\PY{p}{,} \PY{n}{width} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.65}
\PY{n}{bottom}\PY{p}{,} \PY{n}{height} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.65}
\PY{n}{spacing} \PY{o}{=} \PY{l+m+mf}{0.005}

\PY{n}{rect\PYZus{}scatter} \PY{o}{=} \PY{p}{[}\PY{n}{left}\PY{p}{,} \PY{n}{bottom}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{n}{height}\PY{p}{]}
\PY{n}{rect\PYZus{}histx} \PY{o}{=} \PY{p}{[}\PY{n}{left}\PY{p}{,} \PY{n}{bottom} \PY{o}{+} \PY{n}{height} \PY{o}{+} \PY{n}{spacing}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{]}
\PY{n}{rect\PYZus{}histy} \PY{o}{=} \PY{p}{[}\PY{n}{left} \PY{o}{+} \PY{n}{width} \PY{o}{+} \PY{n}{spacing}\PY{p}{,} \PY{n}{bottom}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{height}\PY{p}{]}

\PY{c+c1}{\PYZsh{} start with a rectangular Figure}
\PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,} \PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}

\PY{n}{ax\PYZus{}scatter} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}scatter}\PY{p}{)}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{top}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{right}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\PY{n}{ax\PYZus{}histx} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}histx}\PY{p}{)}
\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{labelbottom}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\PY{n}{ax\PYZus{}histy} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}histy}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{labelleft}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}

\PY{c+c1}{\PYZsh{} the scatter plot:}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{hist2d}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{,} \PY{n}{norm}\PY{o}{=}\PY{n}{colors}\PY{o}{.}\PY{n}{LogNorm}\PY{p}{(}\PY{p}{)}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{GnBu}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}

\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{set\PYZus{}xlim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{4}\PY{p}{,} \PY{l+m+mi}{4}\PY{p}{)}\PY{p}{)}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{set\PYZus{}ylim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{4}\PY{p}{,} \PY{l+m+mi}{4}\PY{p}{)}\PY{p}{)}

\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{,} \PY{n}{orientation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{horizontal}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{set\PYZus{}xlim}\PY{p}{(}\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{get\PYZus{}xlim}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{set\PYZus{}ylim}\PY{p}{(}\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{get\PYZus{}ylim}\PY{p}{(}\PY{p}{)}\PY{p}{)}

\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{copula_files/copula_9_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Now use what we have just seen to \emph{uniformify} the marginals:

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{norm} \PY{o}{=} \PY{n}{stats}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{p}{)}
\PY{n}{x\PYZus{}unif} \PY{o}{=} \PY{n}{norm}\PY{o}{.}\PY{n}{cdf}\PY{p}{(}\PY{n}{x}\PY{p}{)}

\PY{c+c1}{\PYZsh{} definitions for the axes}
\PY{n}{left}\PY{p}{,} \PY{n}{width} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.65}
\PY{n}{bottom}\PY{p}{,} \PY{n}{height} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.65}
\PY{n}{spacing} \PY{o}{=} \PY{l+m+mf}{0.005}

\PY{n}{rect\PYZus{}scatter} \PY{o}{=} \PY{p}{[}\PY{n}{left}\PY{p}{,} \PY{n}{bottom}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{n}{height}\PY{p}{]}
\PY{n}{rect\PYZus{}histx} \PY{o}{=} \PY{p}{[}\PY{n}{left}\PY{p}{,} \PY{n}{bottom} \PY{o}{+} \PY{n}{height} \PY{o}{+} \PY{n}{spacing}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{]}
\PY{n}{rect\PYZus{}histy} \PY{o}{=} \PY{p}{[}\PY{n}{left} \PY{o}{+} \PY{n}{width} \PY{o}{+} \PY{n}{spacing}\PY{p}{,} \PY{n}{bottom}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{height}\PY{p}{]}

\PY{c+c1}{\PYZsh{} start with a rectangular Figure}
\PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,} \PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}

\PY{n}{ax\PYZus{}scatter} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}scatter}\PY{p}{)}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{top}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{right}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\PY{n}{ax\PYZus{}histx} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}histx}\PY{p}{)}
\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{labelbottom}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\PY{n}{ax\PYZus{}histy} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}histy}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{labelleft}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}

\PY{c+c1}{\PYZsh{} the scatter plot:}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{hist2d}\PY{p}{(}\PY{n}{x\PYZus{}unif}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{x\PYZus{}unif}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{,} \PY{n}{norm}\PY{o}{=}\PY{n}{colors}\PY{o}{.}\PY{n}{LogNorm}\PY{p}{(}\PY{p}{)}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{GnBu}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}

\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{set\PYZus{}xlim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{1.1}\PY{p}{)}\PY{p}{)}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{set\PYZus{}ylim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{1.1}\PY{p}{)}\PY{p}{)}

\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x\PYZus{}unif}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x\PYZus{}unif}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{,} \PY{n}{orientation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{horizontal}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{set\PYZus{}xlim}\PY{p}{(}\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{get\PYZus{}xlim}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{set\PYZus{}ylim}\PY{p}{(}\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{get\PYZus{}ylim}\PY{p}{(}\PY{p}{)}\PY{p}{)}

\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{copula_files/copula_11_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    This scatter plot above is usually how copulas are visualized. Finally
we can just transform the marginals again from uniform to what we want
(e.g.~Gumbel and Beta):

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{m1} \PY{o}{=} \PY{n}{stats}\PY{o}{.}\PY{n}{gumbel\PYZus{}l}\PY{p}{(}\PY{p}{)}
\PY{n}{m2} \PY{o}{=} \PY{n}{stats}\PY{o}{.}\PY{n}{beta}\PY{p}{(}\PY{n}{a}\PY{o}{=}\PY{l+m+mi}{10}\PY{p}{,} \PY{n}{b}\PY{o}{=}\PY{l+m+mi}{3}\PY{p}{)}

\PY{n}{x1\PYZus{}trans} \PY{o}{=} \PY{n}{m1}\PY{o}{.}\PY{n}{ppf}\PY{p}{(}\PY{n}{x\PYZus{}unif}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
\PY{n}{x2\PYZus{}trans} \PY{o}{=} \PY{n}{m2}\PY{o}{.}\PY{n}{ppf}\PY{p}{(}\PY{n}{x\PYZus{}unif}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}

\PY{c+c1}{\PYZsh{} definitions for the axes}
\PY{n}{left}\PY{p}{,} \PY{n}{width} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.65}
\PY{n}{bottom}\PY{p}{,} \PY{n}{height} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.65}
\PY{n}{spacing} \PY{o}{=} \PY{l+m+mf}{0.005}

\PY{n}{rect\PYZus{}scatter} \PY{o}{=} \PY{p}{[}\PY{n}{left}\PY{p}{,} \PY{n}{bottom}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{n}{height}\PY{p}{]}
\PY{n}{rect\PYZus{}histx} \PY{o}{=} \PY{p}{[}\PY{n}{left}\PY{p}{,} \PY{n}{bottom} \PY{o}{+} \PY{n}{height} \PY{o}{+} \PY{n}{spacing}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{]}
\PY{n}{rect\PYZus{}histy} \PY{o}{=} \PY{p}{[}\PY{n}{left} \PY{o}{+} \PY{n}{width} \PY{o}{+} \PY{n}{spacing}\PY{p}{,} \PY{n}{bottom}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{height}\PY{p}{]}

\PY{c+c1}{\PYZsh{} start with a rectangular Figure}
\PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,} \PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}

\PY{n}{ax\PYZus{}scatter} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}scatter}\PY{p}{)}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{top}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{right}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\PY{n}{ax\PYZus{}histx} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}histx}\PY{p}{)}
\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{labelbottom}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\PY{n}{ax\PYZus{}histy} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}histy}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{labelleft}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}

\PY{c+c1}{\PYZsh{} the scatter plot:}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{hist2d}\PY{p}{(}\PY{n}{x1\PYZus{}trans}\PY{p}{,} \PY{n}{x2\PYZus{}trans}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{,} \PY{n}{norm}\PY{o}{=}\PY{n}{colors}\PY{o}{.}\PY{n}{LogNorm}\PY{p}{(}\PY{p}{)}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{GnBu}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}

\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{set\PYZus{}xlim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{8}\PY{p}{,} \PY{l+m+mf}{2.5}\PY{p}{)}\PY{p}{)}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{set\PYZus{}ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}

\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x1\PYZus{}trans}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x2\PYZus{}trans}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{,} \PY{n}{orientation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{horizontal}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{set\PYZus{}xlim}\PY{p}{(}\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{get\PYZus{}xlim}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{set\PYZus{}ylim}\PY{p}{(}\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{get\PYZus{}ylim}\PY{p}{(}\PY{p}{)}\PY{p}{)}

\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{copula_files/copula_13_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    It is now interesting to compare with the joint distribution without
correlations:

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{x1} \PY{o}{=} \PY{n}{m1}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{l+m+mi}{10000}\PY{p}{)}
\PY{n}{x2} \PY{o}{=} \PY{n}{m2}\PY{o}{.}\PY{n}{rvs}\PY{p}{(}\PY{l+m+mi}{10000}\PY{p}{)}

\PY{c+c1}{\PYZsh{} definitions for the axes}
\PY{n}{left}\PY{p}{,} \PY{n}{width} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.65}
\PY{n}{bottom}\PY{p}{,} \PY{n}{height} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{l+m+mf}{0.65}
\PY{n}{spacing} \PY{o}{=} \PY{l+m+mf}{0.005}

\PY{n}{rect\PYZus{}scatter} \PY{o}{=} \PY{p}{[}\PY{n}{left}\PY{p}{,} \PY{n}{bottom}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{n}{height}\PY{p}{]}
\PY{n}{rect\PYZus{}histx} \PY{o}{=} \PY{p}{[}\PY{n}{left}\PY{p}{,} \PY{n}{bottom} \PY{o}{+} \PY{n}{height} \PY{o}{+} \PY{n}{spacing}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{]}
\PY{n}{rect\PYZus{}histy} \PY{o}{=} \PY{p}{[}\PY{n}{left} \PY{o}{+} \PY{n}{width} \PY{o}{+} \PY{n}{spacing}\PY{p}{,} \PY{n}{bottom}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{,} \PY{n}{height}\PY{p}{]}

\PY{c+c1}{\PYZsh{} start with a rectangular Figure}
\PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{8}\PY{p}{,} \PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}

\PY{n}{ax\PYZus{}scatter} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}scatter}\PY{p}{)}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{top}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{right}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\PY{n}{ax\PYZus{}histx} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}histx}\PY{p}{)}
\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{labelbottom}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
\PY{n}{ax\PYZus{}histy} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{axes}\PY{p}{(}\PY{n}{rect\PYZus{}histy}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{tick\PYZus{}params}\PY{p}{(}\PY{n}{direction}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{in}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{labelleft}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}

\PY{c+c1}{\PYZsh{} the scatter plot:}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{hist2d}\PY{p}{(}\PY{n}{x1}\PY{p}{,} \PY{n}{x2}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{,} \PY{n}{norm}\PY{o}{=}\PY{n}{colors}\PY{o}{.}\PY{n}{LogNorm}\PY{p}{(}\PY{p}{)}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{GnBu}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}

\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{set\PYZus{}xlim}\PY{p}{(}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{8}\PY{p}{,} \PY{l+m+mf}{2.5}\PY{p}{)}\PY{p}{)}
\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{set\PYZus{}ylim}\PY{p}{(}\PY{p}{(}\PY{l+m+mf}{0.2}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}

\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x1}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{hist}\PY{p}{(}\PY{n}{x2}\PY{p}{,} \PY{n}{bins}\PY{o}{=}\PY{l+m+mi}{50}\PY{p}{,} \PY{n}{orientation}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{horizontal}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}

\PY{n}{ax\PYZus{}histx}\PY{o}{.}\PY{n}{set\PYZus{}xlim}\PY{p}{(}\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{get\PYZus{}xlim}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\PY{n}{ax\PYZus{}histy}\PY{o}{.}\PY{n}{set\PYZus{}ylim}\PY{p}{(}\PY{n}{ax\PYZus{}scatter}\PY{o}{.}\PY{n}{get\PYZus{}ylim}\PY{p}{(}\PY{p}{)}\PY{p}{)}

\PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{copula_files/copula_15_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Using the uniform distribution as a common base for our transformations
we can easily introduce correlations and flexibly construct complex
probability distributions. Clearly this is directly extendeable to
higher dimensional distributions as well.

\section{Application to Finance}\label{application-to-finance}

In credit derivative valuation and credit risk management, one of the
fundamentally important issues is the estimation of default
probabilities and their correlations. For this, generally speaking,
there are two ways: using historical default data or using mathematical
models.

Historical default data has played an important role in the estimation
of default probabilities. However, because default events are rare,
there is very limited default data available. Moreover, historical data
reflects the historical default pattern only and it may not be a proper
indicator of the future. This makes the estimation of default
probabilities from historical data difficult and inexact. To use this
same data to estimate default correlations is even more difficult and
more inexact.

The market trend now is towards more and more to the use of mathematical
models that don't rely on historical default data. In the previous
chapter we have seen how it is possible to derive default probabilities
from market data. Before going into the details of the application of
the copula to default probabilities let's introduce two more kind of
contracts.

\subsection{Basket Default Swaps}\label{basket-default-swaps}

A basket default swap is a credit derivative on a portfolio of reference
entities. The simplest basket default swaps are first-to-default swaps,
second-to-default swaps, and nth-to-default swaps. With respect to a
basket of reference entities, a first-to-default swap provides insurance
for only the first default, a second-to-default swap provides insurance
for only the second default, an nth-to-default swap provides insurance
for only the nth default. For example, in an nth-to-default swap, the
protection seller does not make a payment to the protection buyer for
the first n−1 defaulted reference entities, and makes a payment for the
nth defaulted reference entity. Once there is a payment upopn the
default of the nth defaulted reference entity, the swap terminates.

\subsubsection{Collateralized Debt Obligation}\label{collateralized-debt-obligation}

A collateralized debt obligation (CDO) is a security backed by a
diversified pool of one or more kinds of debt obligations such as bonds,
loans, credit default swaps or structured products (mortgage-backed
securities, asset-backed securities, and even other CDOs). A CDO can be
initiated by one or more of the following: banks, nonbank financial
institutions, and asset management companies, is referred to as the
sponsor. The sponsor of a CDO creates a company so-called the special
purpose vehicle (SPV). The SPV works as an independent entity. In this
way, CDO investors are isolated from the credit risk of the sponsor.
Moreover, the SPV is responsible for the administration. The SPV obtains
the credit risk exposure by purchasing debt obligations (bonds or
residential and commercial loans) or selling CDSs; it transfers the
credit risk by issuing debt obligations (tranches/credit-linked notes).
The investors in the tranches of a CDO have the ultimate credit risk
exposure to the underlying reference entities. The SPV issues four kinds
of tranches. Each tranche has an attachment percentage and a detachment
percentage. When the cumulative percentage loss of the portfolio reaches
the attachment percentage, investors in the tranche start to lose their
principal, and when the cumulative percentage loss of principal reaches
the detachment percentage, the investors in the tranche lose all their
principal and no further loss can occur to them.

In the literature, tranches of a CDO are classified as
subordinate/equity tranche, mezzanine tranches, and senior tranches
according to their subordinate levels. Because the equity tranche is
extremely risky, the sponsor of a CDO holds the equity tranche and the
SPV sells other tranches to investors.

\subsection{Calculating first-to-default, nth-to-default and
all-to-default
probabilities}\label{calculating-first-to-default-nth-to-default-and-all-to-default-probabilities}

\paragraph{Independent Defaults}\label{independent-defaults}

If the default times of the names of a basket are independent,
first-to-default, nth-to-default, all-to-default probabilities can be
calculated through multiplication and integration of the default
probability curves of the basket components.

As an example, we consider the second-to-default probability of a 4-name
basket. Let \(\tau_i\) be the default time of name \(i\) and \(F_i(t)\)
its distribution. Then the probability that name 1 defaults second in
the basket before time \(t\) and before the counter-party defaults:

\[P((\tau_2\lt\tau_1)\cap (\tau_1\lt t)\cap (\tau_1\lt\tau_3)\cap (\tau_1\lt\tau_4)) +
P((\tau_3\lt\tau_1)\cap (\tau_1\lt t)\cap (\tau_1\lt\tau_2)\cap (\tau_1\lt\tau_4)) =
\int_0^t{F_2 (s)\cdot (1-F_3 (s)) \cdot (1-F_4 (s))~dF_1(s)} +  \int_0^t{F_3 (s)\cdot (1-F_2 (s)) \cdot (1-F_4 (s))~dF_1(s)}\]

The formula for nth-to-default probability before the counterparty
defaults in a general basket can be derived similarly. However,
complexity increases as the number of names increases. The above method
can also apply to derive the formula of all-to-default probability
before the counter-party defaults. This is clearly much simpler than the
nth-to-default case.

Suppose the default probabilities of three companies, A, B and C are
given as in the following table:

\begin{center}
\begin{tabular}{|c|c|c|c|}
time in years & A & B & C \\
\hline
0 & 0 & 0 & 0 \\
1 & 0.022032 & 0.0317 & 0.035 \\
2 & 0.046242 & 0.0655 & 0.075 \\
3 & 0.07266 & 0.1022 & 0.121 \\
4 & 0.101233 & 0.142 & 0.153 \\
5 & 0.131885 & 0.1752 & 0.205 \\
\end{tabular}
\end{center}

and suppose that the default events of the three companies are
independent. Using linear interpolation for default probability curves,
let's get the table of first-to-default probabilities for the three
companies.

The default probabilities are linear in each time interval so the
integral above can be solved by substitution:

\[ \int_{x_0}^{x_1}{(1-F_B(x))(1-F_C(x))dF_A(x)}\]

Setting \(t=m_A x + q_A\) it becomes with \(m_A, q_A\) are the
parameters of the line joining the default probabilities of company A:

\[ \int_{m_A x_0 + q_A}^{m_A x_1 + q_A}{(1-F_B(x(t)))(1-F_C(x(t)))dt}~~~~~~\textrm{, with}~x(t) = \cfrac{t -q_A}{m_A} \]
and similarly for company B and C.

To convert it into python we can use \texttt{scipy.integrate.quad} to
perform the integral and \texttt{numpy.interp} to determine the
intermediate default probabilities.

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k+kn}{from} \PY{n+nn}{scipy}\PY{n+nn}{.}\PY{n+nn}{integrate} \PY{k}{import} \PY{n}{quad}
\PY{k+kn}{from} \PY{n+nn}{numpy} \PY{k}{import} \PY{n}{interp}

\PY{n}{default\PYZus{}rates} \PY{o}{=} \PY{p}{\PYZob{}}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{A}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mf}{0.022032}\PY{p}{,} \PY{l+m+mf}{0.046242}\PY{p}{,} \PY{l+m+mf}{0.07266}\PY{p}{,} \PY{l+m+mf}{0.101233}\PY{p}{,} \PY{l+m+mf}{0.131885}\PY{p}{)}\PY{p}{,} \PY{c+c1}{\PYZsh{} company A}
                 \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{B}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mf}{0.0317}\PY{p}{,} \PY{l+m+mf}{0.0655}\PY{p}{,} \PY{l+m+mf}{0.1022}\PY{p}{,} \PY{l+m+mf}{0.142}\PY{p}{,} \PY{l+m+mf}{0.1752}\PY{p}{)}\PY{p}{,} \PY{c+c1}{\PYZsh{} company B}
                 \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{C}\PY{l+s+s2}{\PYZdq{}}\PY{p}{:}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mf}{0.035}\PY{p}{,} \PY{l+m+mf}{0.075}\PY{p}{,} \PY{l+m+mf}{0.121}\PY{p}{,} \PY{l+m+mf}{0.153}\PY{p}{,} \PY{l+m+mf}{0.205}\PY{p}{)}\PY{p}{\PYZcb{}} \PY{c+c1}{\PYZsh{} company C}

\PY{k}{def} \PY{n+nf}{func}\PY{p}{(}\PY{n}{x}\PY{p}{,} \PY{n}{default}\PY{p}{,} \PY{n}{companies}\PY{p}{,} \PY{n}{t}\PY{p}{)}\PY{p}{:}
    \PY{n}{m} \PY{o}{=} \PY{n}{default}\PY{p}{[}\PY{n}{companies}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{[}\PY{n}{t}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{default}\PY{p}{[}\PY{n}{companies}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{[}\PY{n}{t}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}
    \PY{n}{q} \PY{o}{=} \PY{n}{default}\PY{p}{[}\PY{n}{companies}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{[}\PY{n}{t}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{m} \PY{o}{*} \PY{p}{(}\PY{n}{t}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}
    \PY{n}{t} \PY{o}{=} \PY{p}{(}\PY{n}{x}\PY{o}{\PYZhy{}}\PY{n}{q}\PY{p}{)}\PY{o}{/}\PY{n}{m}
    \PY{n}{F2} \PY{o}{=} \PY{l+m+mi}{1} \PY{o}{\PYZhy{}} \PY{n}{interp}\PY{p}{(}\PY{n}{t}\PY{p}{,} \PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{default}\PY{p}{[}\PY{n}{companies}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{default}\PY{p}{[}\PY{n}{companies}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{)}
    \PY{n}{F3} \PY{o}{=} \PY{l+m+mi}{1} \PY{o}{\PYZhy{}} \PY{n}{interp}\PY{p}{(}\PY{n}{t}\PY{p}{,} \PY{n+nb}{range}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{default}\PY{p}{[}\PY{n}{companies}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{default}\PY{p}{[}\PY{n}{companies}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{]}\PY{p}{)}
    \PY{k}{return} \PY{n}{F2}\PY{o}{*}\PY{n}{F3}

\PY{k}{def} \PY{n+nf}{integral}\PY{p}{(}\PY{n}{default}\PY{p}{,} \PY{n}{companies}\PY{p}{,} \PY{n}{t}\PY{p}{)}\PY{p}{:}
    \PY{k}{return} \PY{n}{quad}\PY{p}{(}\PY{n}{func}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{n}{default}\PY{p}{[}\PY{n}{companies}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}\PY{p}{[}\PY{n}{t}\PY{p}{]}\PY{p}{,} \PY{n}{args}\PY{o}{=}\PY{p}{(}\PY{n}{default}\PY{p}{,} \PY{n}{companies}\PY{p}{,} \PY{n}{t}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
                 
\PY{k}{for} \PY{n}{companies} \PY{o+ow}{in} \PY{p}{[}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{A}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{B}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{C}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{B}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{A}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{C}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{C}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{A}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{B}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}\PY{p}{]}\PY{p}{:}
    \PY{n}{prob} \PY{o}{=} \PY{l+m+mi}{0}
    \PY{k}{for} \PY{n}{t} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{)}\PY{p}{:}
        \PY{n}{prob} \PY{o}{=} \PY{n}{integral}\PY{p}{(}\PY{n}{default\PYZus{}rates}\PY{p}{,} \PY{n}{companies}\PY{p}{,} \PY{n}{t}\PY{p}{)}
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{First to default prob at time (}\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s2}{) for company }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s2}{: }\PY{l+s+si}{\PYZob{}:.5f\PYZcb{}}\PY{l+s+s2}{\PYZdq{}}\PY{o}{.}\PY{n}{format}\PY{p}{(}\PY{n}{t}\PY{p}{,} \PY{n}{companies}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{prob}\PY{p}{)}\PY{p}{)}
\end{Verbatim}
\end{tcolorbox}

    \begin{Verbatim}[commandchars=\\\{\}]
First to default prob at time (1) for company A: 0.02131
First to default prob at time (2) for company A: 0.04301
First to default prob at time (3) for company A: 0.06460
First to default prob at time (4) for company A: 0.08573
First to default prob at time (5) for company A: 0.10606
First to default prob at time (1) for company B: 0.03080
First to default prob at time (2) for company B: 0.06160
First to default prob at time (3) for company B: 0.09245
First to default prob at time (4) for company B: 0.12315
First to default prob at time (5) for company B: 0.15018
First to default prob at time (1) for company C: 0.03407
First to default prob at time (2) for company C: 0.07071
First to default prob at time (3) for company C: 0.10986
First to default prob at time (4) for company C: 0.13879
First to default prob at time (5) for company C: 0.17011
    \end{Verbatim}

\paragraph{Correlated Defaults}\label{correlated-defaults}

However, if the default times are not independent, no simple formulas
are available for these types of probabilities. Monte Carlo simulation
is generally used instead. To generate default scenarios we need a model
for default times. The most popular models are the Brownian motion
credit index process and the normal copula.

\section{Complex Correlation Structures and the Financial
Crisis}\label{complex-correlation-structures-and-the-financial-crisis}

In the example above we have used the multivariate normal which gave
rise to the Gaussian copula.However, we can use other and more complex
copulas as well. For example we might want to assume the correlation is
non-symmetruc which is useful in quant finance where correlations become
very strong during market crashes and returns very negative.

Infact, Gaussian copulas are said to have played a key role in the 2008
financial crisis as tail-correlations were severely underestimated.
Consider a set of mortgages in CDOs (a particular kind of contract that
we are going to see) they are clearly correlated, if one mortgage fails,
the likelihood that another failing is increased. In the early 2000s,
the banks only knew how to model the marginals of the default rates. An
(in)famous paper by Li then suggested to use copulas to model the
correlations between those marginals. Rating agencies relied on thid
model so heaviy, severely underestimating risk and giving false
ratings\ldots{}

If you are interested in the argument read
\href{http://timmurphy.org/2009/07/22/line-spacing-in-latex-documents/}{this paper}
for an excellent description of Gaussian copulas and the Financial
Crisis which argues that different copula choices would not have made a
difference but instead the assumed correlation was way too low.

